#!/usr/bin/env node
'use strict';

var commander = require('commander');
var glob = require('glob');
var jScrambler = require('../jscrambler');
var cli = require('../lib/cli');
var path = require('path');

commander
  .version(require('../package.json').version)
  .usage('[source files] [options]')
  .option('-c, --config [config]', 'JScrambler configuration options')
  .option('-o, --output [output]', 'Output directory. If not specified the output is printed.')
  .option('-a, --access-key <accessKey>', 'Access key')
  .option('-s, --secret-key <secretKey>', 'Secret key')
  .option('-h, --host [host]', 'Hostname')
  .option('-p, --port [port]', 'Port')
  .option('-v, --api-version [apiVersion]', 'Version')
  .option('--asserts-elimination [assertsElimination]', 'Remove function definitions and function calls with a given name.')
  .option('--browser-os-lock [browserOsLock]', 'Locks a JavaScript application to run only on a specific Browser or Operating System.')
  .option('--constant-folding', 'Simplifies constant expressions at compile-time to make your code faster at run-time.')
  .option('--dead-code', 'Randomly injects dead code into the source code.')
  .option('--dead-code-elimination', 'Removes dead code and void code from your JavaScript.')
  .option('--debugging-code-elimination [debuggingCodeElimination', 'Removes statements and public variable declarations used to control the output of debugging messages that help you debug your code.')
  .option('--dictionary-compression', 'further shrink your source code')
  .option('--domain-lock [domainLock]', 'Locks your project to a list of domains you specify.')
  .option('--domain-lock-warning-function [domainLockWarningFunction]', 'Domain lock warning function.')
  .option('--dot-notation-elimination', 'Transforms dot notation to subscript notation.')
  .option('--exceptions-list [exceptionsList]', 'list of exceptions that will never be replaced or used to create new declarations')
  .option('--expiration-date [expirationDate]', 'Sets your JavaScript to expire after a date (YYYY/MM/DD) of your choosing.')
  .option('--expiration-date-warning-function [expirationDateWarningFunction]', 'Expiration date warning function.')
  .option('--function-outlining', 'Turns statements into new function declarations.')
  .option('--function-reorder', 'Randomly reorders your source code\'s function declarations.')
  .option('--ignore-files [ignoreFiles]', 'Define a list of files (relative paths) that JScrambler must ignore.')
  .option('--literal-hooking [literalHooking]', 'Replaces literals by a randomly sized chain of ternary operators. ')
  .option('--literal-duplicates', 'Replaces literal duplicates by a symbol.')
  .option('--member-enumeration', 'Replaces Browser and HTML DOM objects by a member enumeration.')
  .option('--mode [mode]', 'protection mode starter|mobile|html5|nodejs')
  .option('--name-prefix [namePrefix]', 'Set a prefix to be appended to the new names generated by JScrambler.')
  .option('--preserve-annotations', 'Preserve JavaScript comments containing annotations.')
  .option('--rename-all [mode]', 'Renames all identifiers found at your source code.')
  .option('--rename-include [includeList]', 'list of names that you want to force renaming.')
  .option('--rename-local', 'Renames local names only.')
  .option('--self-defending [threshold]', 'thwarting code tampering attempts by using anti-tampering and anti-debugging techniques.')
  .option('--string-splitting [stringSplitting]', 'split strings based on percentage of occurence in the source code input')
  .option('--whitespace', 'enable whitespace')
  .parse(process.argv);


var globSrc;

// If -c, --config file was provided
if (commander.config) {
  // We're using `commander` (CLI) as the source of all truths, falling back to
  // the `config` provided by the file passed as argument
  var config = require(path.resolve(commander.config, '.'));
  commander.output = commander.output || config.filesDest;
  // No need to validate if `keys` are set, later `client` will do so, but first
  // will try to load to the configuration through an `rc` file
  if (config.keys) {
    commander.accessKey = commander.accessKey || config.keys.accessKey;
    commander.secretKey = commander.secretKey || config.keys.secretKey;
  }
  commander.host = commander.host || config.host;
  commander.port = commander.port || config.port;
  commander.apiVersion = commander.apiVersion || config.apiVersion;
  globSrc = config.filesSrc;
}

// If src paths have been provided
if (commander.args.length > 0) {
  globSrc = commander.args;
}

if (!globSrc) {
  commander.outputHelp();
  process.exit(1);
}

var filesSrc = [];
// Iterate `globSrc` to build a list of source files into `filesSrc`
for (var i = 0, l = globSrc.length; i < l; ++i) {
  // Calling sync `glob` because async is pointless for the CLI use case
  // (as of now at least)
  filesSrc = filesSrc.concat(glob.sync(globSrc[i], {dot: true}));
}

// If there's no output directory and we're handling more than one file we can't
// output to CLI so it's pointless to execute the command.
if (!commander.output && filesSrc.length > 1) {
  console.error('Destination must be specified unless only one file is used as input.');
  process.exit(1);
}

// Setup everything
var dest = commander.output;
var accessKey = commander.accessKey;
var secretKey = commander.secretKey;
var host = commander.host;
var port = commander.port && parseInt(commander.port);
var apiVersion = commander.apiVersion;
var params = cli.mergeAndParseParams(commander, config && config.params);
params.files = filesSrc;

// Go, go, go
try {
  var client = new jScrambler.Client({
    keys: {
      accessKey: accessKey,
      secretKey: secretKey
    },
    host: host,
    port: port,
    apiVersion: apiVersion
  });

  jScrambler
    .uploadCode(client, params)
    .then(function (res) {
      return jScrambler.downloadCode(client, res.id);
    })
    .then(function (res) {
      if (filesSrc.length === 1 && !dest) {
        dest = function (buffer, file) {
          process.stdout.write(buffer.toString());
        };
      }
      return jScrambler.unzipProject(res, dest);
    })
    .fail(function (err) {
      // Maybe we could throw here?
      console.error(err);
      process.exit(1);
    });
} catch (ex) {
  console.error(ex.toString());
  process.exit(1);
}
